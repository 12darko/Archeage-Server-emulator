using System;
using ArcheAgeGame.ArcheAge.Network.Packets.Server.Utils;
using ArcheAgeGame.ArcheAge.Structuring.NPC;
using LocalCommons.Logging;
using LocalCommons.Network;
using LocalCommons.Utilities;

namespace ArcheAgeGame.ArcheAge.Network.Packets.Server
{
	public sealed class UnitStatePacket : NetPacket
	{
		public UnitStatePacket(NPC npc) : base(0x01, 0x064)
		{
			try
			{
				NPCs.LoadMonsterData0(npc, npc.ID); //перечитали в базах данные об НПС

				if (npc.LiveObjectID == 0)
				{
					//获取当前NPC的在线索引 Доступ к онлайн - индексу текущей NPC
					var index = NPCs.OnlineNPCList.IndexOf(npc);
					//获取LiveObjectID
					npc.LiveObjectID = ArcheAgeGame.LiveObjectUid.Next();
					//更新当前NPC
					NPCs.OnlineNPCList[index] = npc;
				}
				ns.Write((Uint24)npc.LiveObjectID);   //liveobjectid b3
				//ns.WriteUTF8Fixed(npc.Name, npc.Name.Length); //name SS 
				var name = ""; //Name - должно быть пустым
				ns.WriteUTF8Fixed(name, name.Length); //Name SS 
				ns.Write((byte)UnitType.Npc);         //type d  = 1 NPC
				switch ((byte)UnitType.Npc)
				{
					case 1: //NPC
						ns.Write((Uint24) npc.LiveObjectID); //npc.TargetObjectId); //type bc 3 Чтобы работали клавиши F и G надо чтобы таргет был не 0
						ns.Write((int)npc.ID);       //нужно вставлять Id вместо TemplateId, тогда имя отображается правильно
						ns.Write((int)0); //type d
						break;
					default: //Actor = 0 and Mate = 2
						break;
				}
				name = ""; //Master
				ns.WriteUTF8Fixed(name, name.Length); //Master SS -  должно быть пустым
				//записываем uint24
				ns.Write(LocalCommons.Utilities.Helpers.ConvertX(npc.Position.X), 0, 3);
				ns.Write(LocalCommons.Utilities.Helpers.ConvertY(npc.Position.Y), 0, 3);
				ns.Write(LocalCommons.Utilities.Helpers.ConvertZ(npc.Position.Z), 0, 3);
				ns.Write((float)npc.Scale);
				ns.Write((byte)npc.Level);
				ns.Write((int)npc.ModelId);

				UnitInfo.WriteItemInfo(npc);          //equipment
				UnitInfo.WritePlayerAppearance(npc); //appearance

				ns.Write((Uint24)0); //bc 3
				ns.Write(npc.Hp * 100); //preciseHealth" type="d"
				ns.Write(npc.Mp * 100); //preciseMana" type="d"

				sbyte point = -1;
				ns.Write((sbyte)point);
				switch (point)
				{
					case -1:
						break;
					default:
						ns.Write((Uint24)0); //bc 3
						break;
				}
				ns.Write((sbyte)point);
				switch (point)
				{
					case -1:
						break;
					default:
						ns.Write((Uint24)0); //bc 3
						ns.Write((byte)0);   //kind" type="c" 
						ns.Write((int)0);    //space" type="d"
						ns.Write((int)0);    //spot" type="d"
						break;
				}

				ns.Write((byte)0); //
				ns.Write((byte)0); //islooted
				ns.Write((byte)0); //activeWeapon
				ns.Write((byte)1); //count
				ns.Write((int)2); //SkillId
				ns.Write((byte)1); //level
				ns.Write((int)0); //bufcount
				ns.Write((sbyte)npc.Direction.X); //rot.x c 
				ns.Write((sbyte)npc.Direction.Y); //rot.y c 
				ns.Write((sbyte)npc.Direction.Z); //rot.z c 
				if (npc.Race == 0)
				{
					ns.Write((byte)0);
				}
				else
				{
					ns.Write((byte)npc.RaceGender); //Gender + Race c
				}
				ns.Write((byte)4); //pish
				ns.WriteHex("00F3660000"); //pisc b = 5
				ns.Write((byte)0); //pish
				ns.Write((int)npc.FactionId); //factionid
				ns.Write((short)0); //pisc
				ns.Write((short)0); //flag
				ns.Write((byte)0); //AbilityCount
				ns.Write((byte)0); //goodBuffCount
				ns.Write((byte)0); //badBuffCount
				ns.Write((byte)0); //hiddenBuffCount
			}
			catch (Exception ex)
			{
				Log.Exception(ex, "Write NPCs Send Stream Error");
			}
		}
		/*
		   UnitStatePacket (пакет об Игроке)
		   op   liveObject len  Canopus        type objectId V                master x      y      z      scale    level modelRef 19{type[1]  type[1]  type[1]  id[1]            type[1] flags[1] 
		   6400 F62501     0700 43616E6F707573 00   BC042200 0000000000000000 0000   99E279 19EC74 36C203 0000803F 04    0A000000    00000000 00000000 5B5B0000 88F1540100000000 00      00       0100000001000000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000000000005C5B000089F154010000000000000100000001000000004600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000000000005E5B00008AF154010000000000000100000001000000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007F530000941A55010000000000010100000001000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B2322F530000000000000000000000000B0000000000000000000000000000000098530000EC2655010000000000010100000001000000009B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096332F530000000000000000000000000B00000000000000000000000000000000EF1700008DF154010000000000000100000001000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000211800008EF154010000000000000100000001000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000007E4D0000425E00000000000000000000000000001802000000000000000000000000000003100800000100000000000000000000000000803F0000803F0000000000000000000000000000803F000000000000803F350200000000803FB10200000000803F0000000050000000000000000000803F0000000005691FFF05691FFF730202FFA90505FF800000F5000011DC000B00000000170000000000F323000000003DC3EF00000000000000000000060000000000000000000001000000000000000000000000000000000000000000000000000000004B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050DC000010D60000FFFF000001028E2E000001D4460000020000000000003111000000000000650000000000000005D2F90000000000A71400000000000000FF00000000FF00000000FF00000000FF00000000FF00000000FF00000000FF00000000FF00000000FF01010000001E3C320028640101010000000000000101000000B119000000F625010000000001010000000000FC0648000000000000000000010000000000000000000000

		   op   liveObject len                 type bc     npcTemplateId type     master x      y      z      scale    level modelRef 19{type[1]                            type[1]                           type[1]  id[1]            type[1] flags[1] 
		   NPC - Кролик
		   6400 926300     0000                01   9BE500 880D0000      00000000 0000   BCDA79 784774 94C603 0000803F 01    C1000000    EA650000 00000000 00000000 00000000 00 B361000000000000000000000000000000B4610000000000000000000000000000009067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002501EC01302000000000000000000004006000048710000FFFF000000010200000001000000000000DA000400F366000000730000000000000000000000
		   6400 60ED00     0000                01   8E1301 880D0000      00000000 0000   74DC79 803474 54CA03 0000803F 01    C1000000    EA650000 00000000000000000000000000 B361000000000000000000000000000000B461000000000000000000000000000000906700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000210B4EE1C02000000000000000000004006000048710000FFFF000000010200000001000000000000FD000400F366000000730000000000000000000000
		   6400 5DD100     0000                01   47FB00 880D0000      00000000 0000   3DF079 DF5074 1CD203 0000803F 01    C1000000    EA650000 00000000000000000000000000 B361000000000000000000000000000000B4610000000000000000000000000000009067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002E05F61D104000000000000000000004006000048710000FFFF0000000102000000010000000000000F000400F366000000730000000000000000000000

		   NPC - Лесной вепрь
		   6400 8E1101     0000                01   782100 930D0000      00000000 0000   6CE779 6E7974 CBC303 0000803F 02    38010000 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000290ACC2000200000000000000000000204E0000B8880000FFFF00000001020000000100000000000009000400A912000000730000000000000000000000

		   NPC - Бекки и Ронин
		   6400 AF2D00     0000                01   D00E00 3E0E0000      00000000 0000   57B979 053D74 C2BD03 3333733F 02    44050000 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002B0A473020200000000000000000000D8590000B8880000FFFF04003E0000000100010200000001000000000000B0000800A66201000000650000000000000000000000
		   6400 422D00     0000                01   630E00 3F0E0000      00000000 0000   33B779 9E3A74 99BD03 0000803F 02    3E050000 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002603050020200000000000000000000D8590000B8880000FFFF04003D000000010001020000000100000000000002000800A56201000000650000000000000000000000

		   NPC - Лесной вепрь
		   6400 AF2701     0000                01   3ED500 930D0000      00000000 0000   054D7A FD6475 809C03 0000803F 02    38010000 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002109EDE050200000000000000000000204E0000B8880000FFFF0000000102000000010000000000003B000400EB67000000730000000000000000000000

		   UnitStatePacket
		   B504 DD01
		6400 F52700 0B00 4A757374746F636865636B 00 FF091A0000000000000000000000F5F6790CD27499BC030000803F030B00000000000000000000005B5B00004618C1000000000000000100000001000000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000000000005C5B00004718C1000000000000000100000001000000004600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000000000005E5B00004818C1000000000000000100000001000000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000D61700004918C1000000000000000100000001000000009100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B0000000000000000000000000000000000000000EF1700004A18C1000000000000000100000001000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000003A1800004B18C1000000000000000100000001000000008200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000007F4D0000D85D00000000000000000000000000001B02000000000000000000000000000003BE1000000400000000000000000000000000803F0000803F0000000000000000000000000000803FCF0100000000803FA60000000000803F000000008FC2353F0000000000000000000000000000803FE37B8BFFAFECEFFFAFECEFFF000000FF00000000800000EF00EF00EE0017D40000000000001000000000000000063BB900D800EE00D400281BEBE100E700F037230000000000640000000000000064000000F0000000000000002BD50000006400000000F9000000E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000090B0000078B40000FFFF00000002AB29000001002A000001000000000000D02100000000000065000000000000000000000000FF00000000FF00000000FF00000000FF00000000FF00000000FF920700000000000000FF00000000FF00000000FF01070000001E3C320028640101010000000001020000007709000000F5270000000000010100204E0000000000000000000000000000010000000000000000000000000101000000B119000000F527000000000001010000000000000000000000000000000000010000000000000000000000

		//_type: 0-actor; 1-npc; 2-slave; 3-unk; 4-unk; 5-mate(pet); 6-unk

		op   liveObject len  type bc     npcTemplateId targetId master x      y      z      scale    level modelRef 19{type[1]  type[1]  type[1]  id[1]            type[1] flags[1] 
		NPC - Кролик
		6400 926300     0000 01   9BE500 880D0000      00000000 0000   BCDA79 784774 94C603 0000803F 01    C1000000 EA65000000000000000000000000000000B361000000000000000000000000000000B4610000000000000000000000000000009067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002501EC01302000000000000000000004006000048710000FFFF000000010200000001000000000000DA000400F366000000730000000000000000000000
		NPC - Лесной вепрь
		6400 AF2701     0000 01   3ED500 930D0000      00000000 0000   054D7A FD6475 809C03 0000803F 02    38010000 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002109EDE050200000000000000000000204E0000B8880000FFFF0000000102000000010000000000003B000400EB67000000730000000000000000000000
		*/
	}
}
